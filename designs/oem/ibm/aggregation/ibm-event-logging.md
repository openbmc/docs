# Impact of aggregation and composed systems on IBM error logging

Author: Matt Spinler (mspinler)

Other contributors:

Created: September 8, 2022

## Problem Description
IBM has an upcoming system architecture that consists of more than 1 sled that
can be SMP cabled together into 1 or more composed systems.  There will be a
coordinator application, or group of applications, that may float between sleds
that is responsible for doing operations at a composed system level.  It will
communicate to all non-coordinator entities using Redfish, including
non-coordinator applications on the same BMC.

It is possible that the coordinator will need to create event logs for issues
that span sleds, such as SMP cabling errors, even when the coordinator itself
isn\'t running on a BMC that is part of that composed system.  That event log
will need to end up on a BMC that is in that composed system, and possibly
contain FRU callouts (location codes, part numbers, and serial numbers) from
multiple sleds.

There will be an attached IBM management console, called an HMC (hardware
management console), that also receives all event logs generated by its
attached systems.

## Background and References
IBM BMC implementations use the D-Bus style event logs from the
`phosphor-logging` repository for event logging.  In addition, there is a
'OpenPower PEL' plugin inside phosphor-logging that creates IBM\'s custom event
logs for every D-Bus event log. Those are commonly referred to by IBM as a
'PEL' (Platform Event Log).

PELs are also created by IBM\'s other firmware subsystems, such as Hostboot and
the PowerVM hypervisor, and sent down to the BMC to store.  The BMC sends the
PELs it receives or creates to the operating system via the hypervisor using
PLDM. PELs are also sent to any attached IBM HMCs (hardware management
consoles) using bmcweb eventing.

PELs can contain up to 10 FRU callouts which contain location codes and serial
numbers to identify which FRUs need to be replaced to resolve the issue.
Callouts can also be maintenance procedure names that are documented online
when the repair action is more complex than just replacing parts.

## Requirements
The new requirements on IBM\'s event logging created by this new system
architecture are:

* The software in the coordinator namespace must be able to tell any BMC it has
  access to, including the one it is running on and others, to create and store
  a PEL, and thus a D-Bus event log.  Currently, the specific PEL to create is
  determined by the 'Message' property of the D-Bus event log.  This implies
  that at a minimum the value of the Message property to use must be
  transmitted to the target BMC.

* As the coordinator only communicates with non-coordinator software via
  Redfish, then the method to create the event log/PEL must be Redfish.

* There must be a way to add FRUs in remote sleds to the PEL callout list.  At
  the moment this definitely includes the target BMC, as well as possibly other
  BMCs if both ends of an SMP cable need to be called out.

* There must be a way to add FFDC (first failure data capture) to the event
  log/PEL created by the coordinator.  Today that is done with a D-Bus
  interface that allows passing in file descriptors that point to files that
  contain the FFDC.  Somehow that data would need to be passed over Redfish
  first.

With regard to the HMC receiving Redfish events and PELs, there are the
following requirements:
  - As the HMC only has views of composed systems, and only via the
    coordinator, Redfish events that are emitted by the bmcweb instances on the
    BMCs would need to be caught by the coordinator and re-emitted to the HMC,
    possibly changing the event URI to one that contains a coordinated system
    path.  This implies the coordinator must subscribe to the new event log
    events on all BMCs.
  - When the HMC asks the coordinator for Redfish event logs to get the
    attached PEL, the coordinator must retrieve them from the target BMC and
    present them as a composed system view.
  - When the HMC sets the 'ManagementSystemAck' property on an event log, the
    coordinator must route the request to the target BMC with the appropriate
    URI.

There are some additional requirements that aren't related to composed systems
really but it would be helpful if they are documented somewhere.

* PELs can be associated with deconfig records, where a callout of a PEL is
  persistently removed from system use.  That PEL needs to have at least the
  same lifetime as the deconfig record, so if a BMC card is replaced that is
  storing PELs and deconfig records, the PEL somehow needs to survive the
  replacement as deconfig records also need to.  Storing the PEL data inside of
  a deconfig record is one way to solve this (Will move this suggestion to the
  design section when it gets filled in).

* PELs have ID fields in them that must be unique within a composed system,
  which means the included BMCs must all generate unique PEL IDs.  One way to
  do this is to embed the sled position value into a portion of the ID value.
    (Will also move this suggestion to the design section when there is one.)

* External groups have requested a command line tool that can gather and
  display all PELs within a composed system, sorted by time stamp.  It could
  use the existing python module that can parse single PELs.

There are a few non-requirements listed explicitly here in case they are
controversial or wrong.

* The coordinator namespace does not store PELs nor host D-Bus event logs
  itself.  This will always be done by the standard phosphor-logging daemon on
  the BMCs spread across the sleds.

* If the hypervisor image spans BMCs, it only needs to send down a PEL on any
  single member BMC.  In addition, that BMC will then in turn send that PEL
  back to the hypervisor so it can relay it to the operating system.  The
  hypervisor does not need to send down the same PEL on every member BMC, nor
  does it matter which one it selects.

* There is not a requirement to backup PELs on other BMCs for the sake of
  redundancy.  Offloading them to the HMC is considered the redundancy.

* It\'s possible that a composed system member sled may individually lose power
  or be forcibly powered off.  In these cases the composed system would
  checkstop (crash) as processors lost power.  If there is a desire to not
  report both the SMP-link-went-down error and the power errors, then the code
  that creates the former event log will need to handle checking for power
  issues and only create the checkstop event log if necessary.  There will be
  no central event log handler that would wait for both events to show up and
  then decide which to report to the hypervisor and HMC and which to discard.

## Proposed Design
TBD until there has been a decision on what the coordinator software
architecture is.

## Alternatives Considered
TBD until there is a proposed design.

## Impacts
TBD

### Organizational
TBD
- Does this repository require a new repository?  (Yes, No)
- Who will be the initial maintainer(s) of this repository?
- Which repositories are expected to be modified to execute this design?
- Make a list, and add listed repository maintainers to the gerrit review.

## Testing
TBD
