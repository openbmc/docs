# Memory preserving reboot and System Dump extraction flow on POWER Systems.

Author: Dhruvaraj S <dhruvaraj@in.ibm.com>

Created: 15/09/2022

## Problem Description

On composite systems with a single hypervisor image running across the sleds,
a fatal error encountered in the hypervisor must be communicated to one of the
BMCs. Once this information reaches the BMC, it should get propagated to
the SCA, and a memory preserving reboot needs to be started on all sleds in the
composite system to collect a system dump.


## Glossary

- **Boot**: The process of initializing hardware components in a computer system
and loading the operating system.

- **Hostboot**: The firmware runs on the host processors and performs all
processor, bus, and memory initialization on POWER based servers.
[read more](https://github.com/open-power/docs/blob/master/hostboot/HostBoot_PG.md)

- **Self Boot Engine (SBE)**: A microcontroller built into the host processors
of POWER systems to assist in initializing the processor during the boot.
It also acts as an entry point for several hardware access operations to the
processor. [read more](https://sched.co/SPZP)

- **Master Processor**: The processor which gets initialized first to execute
boot firmware.

- **POWER Hardware Abstraction Layer (PHAL)**: A software component on the BMC
providing access to the POWER hardware.

- **Hypervisor**: A hypervisor (or virtual machine monitor, VMM) is a computer
software, firmware, or hardware that creates and runs virtual machines
[read more](https://en.wikipedia.org/wiki/Hypervisor)

- **System Dump**: A dump of main memory and hardware states for debugging the
faults in hypervisor.

- **Memory Preserving Reboot (MPR)**: A method of reboot with preserving the
contents of the volatile memory.

- **Terminate Immediate (TI)**: A condition when the hypervisor encountered
a fatal error and cannot continue with the normal operations.

- **Attention**: The signal generated by the hardware or the firmware for
a specific event.

- **Redfish**: The Redfish standard is a suite of specifications that deliver
an industry-standard protocol providing a RESTful interface for the management
of servers, storage, networking, and converged infrastructure.
[Read More](https://en.wikipedia.org/wiki/Redfish_(specification))

- **OCC**: An On-Chip Controller (OCC) is a co-processor that is embedded
directly on the die of POWER processors. The OCC can be used to controls
the processor frequency, power consumption, and temperature to maximize
performance and minimize energy usage.

[Read More](https://openpowerfoundation.org/on-chip-controller-occ/)
- **Checkstop**: A severe error inside a processor core that causes a processor
core to stop all processing activities.

- **PNOR**: PNOR is a host NOR flash where the firmware is stored.

## Background and References
More information on memory preserving reboot: [](https://github.com/openbmc/docs/blob/master/designs/power-systems-memory-preserving-reboot.md)

When the POWER based server encounters a fault and needs a restart,
it alerts BMC to initiate a memory preserving reboot. BMC starts the reboot
by informing the SBE on each of the processors. SBE stops the running cores and
collects the hardware states in a specified format and store into the host
memory. Once the data is collected, the SBE returns control to the BMC. BMC then
initiates a memory preserved reboot. Once the system finished booting,
the host collects the hardware data and memory contents to create
a dump file in the host memory.

## Requirements

### Primary Requirements

-   System dump should be collected irrespective of the availability of an
    external entity to offload it at the time of a failure.

-   It should provide a mechanism for the user to request a system dump.

-   The server should boot back to runtime

-   The hypervisor should send a special attention to one of the BMC to notify
    about a severe fault.

-   SCA BMC should receive special TI attention from hypervisor

-   SCA BMC should change the host state to 'DiagnosticMode.'and set the same 
    state on all satellite BMCs

-   Satellite BMC should inform SBE to start the memory preserving reboot and
    collect the hardware data.

-   A dump summary should be created with size and other details of the dump

-   Once the dump content is available, the primary hostboot should notify BMC.

-   The primary hostboot should offload the dump to BMC to transfer to an
    external client.

-   Provide Redfish interfaces to manage dump

-   A tool to collect the dump from the server.

-   A method to parse the content of the dump.

## Proposed Design

1. Server fault Notification/User initiated
2. BMC, which receives attention, will analyze the attention With the help of
   the SBE chip-op
3. Inform SCA attention app
4. SCA attention app requests to crash target(state manager) on all connected
   BMCs.
     - Sled level pre-mpreboot steps and enter-mpreboot chip-op on all connected
       SBEs. And SBE collects Hardware Data
     - Each sled will initiate the continue-mpreboot chip-op on its primary SBE
     - The primary SBE starts hostboot on its sled
     - After stitching, the primary hostboot will move dump data to the HDAT
       area
5. The primary hostboot sends the PLDM message to the connected BMC, and the
   associated dump manager creates a dump entry
6. The same Dump manager initiates the dump offload process and packages dumps
   like any other host dumps. 
7. Primary Hostboot deletes dump data and starts phyp.


## Impacts


## Testing

