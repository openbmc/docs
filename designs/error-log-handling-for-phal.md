# Error handling for power Hardware Abstraction Layer (pHAL)

Author:
Devender Rao <devenrao@in.ibm.com> <devenrao>

Primary assignee:
Devender Rao <devenrao@in.ibm.com> <devenrao>

Other contributors:
None

Created:
14/01/2020

## Problem Description
Proposal to provide a mechanism to convert the failure data captured as part of power Hardware Abstraction Layer(pHAL) library calls to
[Platform Event Log](https://github.com/openbmc/phosphor-logging/blob/master/extensions/openpower-pels/README.md)(PEL) format.

## Background and References
OpenBmc Applications use the pHAL layer for hardware access and hardware initialization,
any software/hardware error returned by the pHAL layer need tobe  converted to PEL format
for logging the error entry.

Error data includes register data, targets to [gard] (https://gerrit.openbmc-project.xyz/#/c/openbmc/docs/+/27804/2/designs/gard_on_bmc.md) and callout. Gard refers to the action of "guarding" faulty hardware from impacting future system operation. Callout
points to a specific hardware with in the server that relates to the identified error.

[Phosphor-logging](https://github.com/openbmc/phosphor-logging) [Create](https://github.com/openbmc/phosphor-dbus-interfaces/blob/master/xyz/openbmc_project/Logging/Create.interface.yaml)
interface is used for creating PELs.

pHAL layer constitutes below libraries and and these libraries return different return codes.
1. libipl used for initial program load
2. libfdt for device tree access
3. libekb for hardware procedure execution 
4. libpdbg for hardware access

Proposal is to structure the return data to a standard return code format so that the caller can just handle the single return code format for conversion to PEL.

### Glossary
libfdt: pHAL uses to construct the in-memory tree structure of all targets.
[Reference](https://github.com/dgibson/dtc)

pHAL: power Hardware Abstraction Layer.

libpdbg: library to allow debugging of the host POWER processors from the BMC
[Reference](https://github.com/open-power/pdbg)

MRW: Machine readable workbook. An XML description of a machine as specified by the system owner.

HWP: Hardware procedure. A "black box" code module supplied by the hardware team that initializes host processor and memory subsystems in a platform-independent fashion.

Device Tree: A device tree is a data structure describing the hardware components of a
particular computer so that the operating system's kernel can use and manage those components, including the CPU or CPUs, the memory, the buses and the peripherals.
[Reference](https://elinux.org/Device_Tree_Reference)

EKB: EKB library contains all the hardware procedures (HWP) for the specific platform and corresponding error XML files for each hardware procedure.

PEL: [Platform Entity Log](https://github.com/openbmc/phosphor-logging/blob/master/extensions/openpower-pels/README.md)


## Requirement
### EKB
EKB library contains hardware procedures for the specific platform and the corresponding error xml files for each hardware procedure. Error XML specifies attribute data, targets to callout, targets to gard, and targets to deconfigure for a specific error. Parsers in EKB
library parse the error xml file and generate header file which is used by the hardware
procedure in capturing the failure data.

Exit blocks of the hardware procedure based on the error type capture the error data as defined in the header file generated by parsing the error xml files.

Parsers are provided to parse the error xml to generate header file which will be used by the applications handling the errors to parse the failure data.

Existing parser in libekb needs to be modified to structure the error data in std::map format so that the same can be used in the creation of PEL.

### libipl
Initial prgram load library used for booting the system. Library internally calls hardware
procedures (HWP) of EKB library. Errors returned by the hardware procedures from EKB need
to be returned to the calling application for creation of the PEL.

Any internal software errors or device tree errors need to be captured in an error XML
file. IPL library need to create the return code object based on the format specified in
the error XML file. User applications need to parse the error based on the format specified
in the error XML file.

### libpdbg
libpdbg library is used for hardware access.

Error return codes from libpdbg library calls will be converted to standard return codes by doing the conversion in libekb platform specific layer.

### Message Registry Entries
For errors to be raised in pHal corresponding error message registry entries need to be created in the [message registry](https://github.com/openbmc/phosphor-logging/blob/master/extensions/openpower-pels/registry/message_registry.json).
Captured below is a sample message registry entry for IPL failure.
```
{
            "Name": "xyz.openbmc_project.Common.Error.IStep",
            "Subsystem": "bmc_firmware",
            "Message": "Failure in executing the istep %1.%2",
            "MessageArgSources":
            [
                "SRCWord6", "SRCWord7"
            ],
            "SRC":
            {
                "ReasonCode": "0x1007",
                "Words6To9":
                {
                    "6":
                    {
                        "description": "Major istep number",
                        "AdditionalDataPropSource": "MAJOR_NUM"
                    },

                    "7":
                    {
                        "description": "Minor number",
                        "AdditionalDataPropSource": "MINOR_NUM"
                    }

                }
            },

            "Documentation":
            {
                "Description": "Failure in executing the istep",
                "Message": "Failure in executing the istep"
            }
        }
}
```

## Proposed design
### Hardware procedure failure
platCreateHwpErrParser.pl praser in libekb needs to be modified to parse the standard
return code and return data in std::map format so that the same can be used with the [Create]( https://github.com/openbmc/phosphor-dbus-interfaces/blob/master/xyz/openbmc_project/Logging/Create.interface.yaml) for
creation of PEL.

![image](https://user-images.githubusercontent.com/26330444/72326377-21218400-36d5-11ea-817c-1043e81b0162.png)
  
Inventory strings for the targets to Callout/Gard/Deconfig need to be added to the
additional data section of the Create interface.

### libipl internal failure
An error xml file will be defined for all the possible error scenarios that can occur as
part of ipl library other than errors from hardware procedures.

![image](https://user-images.githubusercontent.com/26330444/72326569-6cd42d80-36d5-11ea-8df0-e6eac8bb4522.png)

### PDBG internal failure
Hardware access is supported only through hardware procedures. For any software errors that
occur as part of PDBG libekb plat code converts the pdbg error to standard return code
format.

![image](https://user-images.githubusercontent.com/26330444/72326642-8f664680-36d5-11ea-8d56-63367acf739c.png)

## Alternatives Considered
None

## Impacts
None

## Future changes
At present using [Create]( https://github.com/openbmc/phosphor-dbus-interfaces/blob/master/xyz/openbmc_project/Logging/Create.interface.yaml) by providing the data in std::map format the same will be changed to Json format when the corresponding support to pass Json files to the Create interface is added.

## Testing
1. Simulate hardware procedure failure and check if PEL is created.
2. Add unit test cases to validate if PEL's are create for errors originating from libipl, libpdbg and libfdt.
