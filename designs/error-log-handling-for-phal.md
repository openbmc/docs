# Error handling for PHAL

Author:
Devender Rao <devenrao@in.ibm.com> <devenrao>

Primary assignee:
None

Other contributors:
None

Created:
14/01/2020

## Problem Description

Proposal to provide mechanism to convert the failure data captured as part of
[Power Hardware Abstraction Layer](https://github.ibm.com/phal)(PHAL) to
[Platform Entity Log](https://github.com/openbmc/phosphor-logging/blob/master/extensions/openpower-pels/README.md)(PEL) format.

## Background and References
Applications use the PHAL layer for hardware access and hardware initialization,
any software/hardware error returned by the PHAL layer need to be converted to 
PEL format for logging the error entry.

Error data includes register data, targets to deconfigure, targets to gard,
and targets to callout. 

[Phosphor-logging](https://github.com/openbmc/phosphor-logging) [Create](https://github.com/openbmc/phosphor-dbus-interfaces/blob/master/xyz/openbmc_project/Logging/Create.interface.yaml) 
interface is used for creating PELs.

PHAL layer constitutes libipl used for initial program load, libfdt for device
tree access, libekb for hardware procedure execution and libpdbg for hardware
access, and these libraries return different return codes.

Proposal is to structure the return data to a standard [fapi2::ReturnCode](https://github.ibm.com/openbmc/ekb/blob/77fdd0a50283eaf56e5ede976fd78f14c0075b2d/hwpf/fapi2/include/return_code.H)  
format so that the caller can just handle the single return code format for
conversion to PEL.

### Glossary
CEC: Central Electronics Complex , which includes  host processor and memory
subsystems.

IPL: Initial program load. The time between when power is applied to the
platform hardware and when the payload is fully functional.

libfdt: pHAL uses to construct the in-memory tree structure of all targets. 
[Reference](https://github.com/dgibson/dtc)

pHAL: Power Hardware Abstraction Layer.

pdbg: Application to allow debugging of the host POWER processors from the BMC
[Reference](https://github.com/open-power/pdbg)

MRW: Machine readable workbook. An XML description of a machine as specified
by the system owner.

HWP: Hardware procedure. A "black box" code module supplied by the hardware team
that initializes CEC hardware in a platform-independent fashion.

Device Tree: Data structre describing the CEC hardware components and properties. [Reference](https://elinux.org/Device_Tree_Reference)

EKB: EKB library contains all the hardware procedures (HWP) for the specific
platform and corresponding error xml files for each hardware procedure.

PEL: [Platform Entity Log](https://github.com/openbmc/phosphor-logging/blob/master/extensions/openpower-pels/README.md)


## Requirement
### EKB
EKB libraries contains hardware procedures for the specific platform and the
corresponding error xml files for each hardware procedure. Error XML specifies
attribute data, targets to callout, targets to gard, and targets to
deconfigure for a specific error. Parsers in EKB library parse the error xml
file and generate header file which is used by the hardware procedure in
capturing the failure data.

Exit blocks of the hardware procedure based on the error type capture the
error data as defined in the header file generated by parsing the error xml
files.

Parsers are provided to parse the error xml to generate header file which will
be used by the applications handling the errors to parse the failure data.

Existing parser in libekb needs to be modified to structure the error data in
stl::map format so that the same can be used in the creation of PEL.

### IPL
IPL library internally calls hardware procedures (HWP) and errors returned by
the hardware procedures are usually in the standard fapi2::ReturnCode format
and the same need to be returned to the calling application.

Any internal software errors or device tree errors need to be captured in an
error XML file so that the same can be used by the caller and the IPL library
to format and parse the data during failure.

### PDBG
PDBG library is used for hardware access, for any hardware access by the
applications need to go through hardware procedures.

For any software errors occurring in PDBG, error xml file needs to be defined in
EKB, a wrapper need to be defined to convert the PDBG error to standard
fapi2::ReturnCode format.

### Message Registry Entries
For errors for which PEL's need to be created corresponding error message
registry entries need to be created in the [message registry](https://github.com/openbmc/phosphor-logging/blob/master/extensions/openpower-pels/registry/message_registry.json).
Captured below is a sample message registry entry for IPL failure.
```
{
            "Name": "xyz.openbmc_project.Common.Error.IStep",
            "Subsystem": "bmc_firmware",

            "SRC":
            {
                "ReasonCode": "0x1007",
                "Words6To9":
                {
                    "6":
                    {
                        "description": "Major istep number",
                        "AdditionalDataPropSource": "MAJOR_NUM"
                    },

                    "7":
                    {
                        "description": "Minor number",
                        "AdditionalDataPropSource": "MINOR_NUM"
                    }

                }
            },

            "Documentation":
            {
                "Description": "Failure in executing the istep",
                "Message": "Failure in executing the istep"
            }
        }
}
```

## Proposed design
### Hardware procedure failure
platCreateHwpErrParser.pl praser in libekb needs to be modified to parse the
fapi2::ReturnCode and return data in stl::map format so that the same can be
used with the [Create]( https://github.com/openbmc/phosphor-dbus-interfaces/blob/master/xyz/openbmc_project/Logging/Create.interface.yaml) for
creation of PEL.

![image](https://user-images.githubusercontent.com/26330444/72326377-21218400-36d5-11ea-817c-1043e81b0162.png)

### libipl internal failure
An error xml file will be defined for all the possible error scenarios that can
occur as part of ipl library other than errors from hardware procedures.

![image](https://user-images.githubusercontent.com/26330444/72326569-6cd42d80-36d5-11ea-8df0-e6eac8bb4522.png)

### PDBG internal failure
Hardware access is supported only through hardware procedure. For any software
errors that occur as part of PDBG libekb plat code converts the pdbg error to
fapi2::ReturnCode format

![image](https://user-images.githubusercontent.com/26330444/72326642-8f664680-36d5-11ea-8d56-63367acf739c.png)

## Alternatives Considered
None

## Impacts
None

## Testing
Test applications will be written to simulate hardware procedure failure and
verify if PEL is created.
