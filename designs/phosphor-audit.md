# phosphor-audit

Author:
  Ivan Mikhaylov, [i.mikhaylov@yadro.com](mailto:i.mikhaylov@yadro.com)

Primary assignee:
  Ivan Mikhaylov, [i.mikhaylov@yadro.com](mailto:i.mikhaylov@yadro.com)

Other contributors:
  Alexander Amelkin, [a.amelkin@yadro.com](mailto:a.amelkin@yadro.com)
  Alexander Filippov, [a.filippov@yadro.com](mailto:a.filippov@yadro.com)

Created:
  23.07.2019

## Problem Description

End users of OpenBMC may take actions that change the system state and/or
configuration. Such actions may be taken using any of the numerous interfaces
provided by OpenBMC. That includes RedFish, IPMI, ssh or serial console shell,
and other interfaces, including the future ones.

Consequences of those actions may sometimes be harmful and an investigation may
be conducted in order to find out the person responsible for the unwelcome
changes. Currently, most changes leave no trace in OpenBMC logs, which hampers
the aforementioned investigation.

It is required to develop a mechanism that would allow for tracking such
user activity, logging it, and taking certain actions if necessary.

## Background and References

YADRO had an internal solution for the problem. It was only applicable to an
outdated version of OpenBMC and needed a redesign. There was also a parallel
effort by IBM that can be found here:
[REST and Redfish Traffic Logging](https://gerrit.openbmc-project.xyz/c/openbmc/bmcweb/+/22699)

## Assumptions

This design assumes that an end user is never given a direct access to the
system shell. The shell allows for direct manipulation of user database
(add/remove users, change passwords) and system configuration (network scripts,
etc.), and it doesn't seem feasible to track such user actions taken within the
shell. This design assumes that all user interaction with OpenBMC is limited to
controlled interfaces served by other Phosphor OpenBMC components interacting
via D-Bus.

## Requirements

 * Provide a unified method of logging user actions independent of the user
   interface, where possible user actions are:
   * Redfish/REST PUT/POST/DELETE/PATCH
   * IPMI
   * PAM
 * Provide a way to configure system response actions taken upon certain user
   actions, where possible response actions are:
   * Log an event
   * Notify an administrator or an arbitrary notification receiver
   * Run an arbitrary command
 * Provide a way to configure notification receivers:
   * E-mail
   * SNMP
   * Instant messengers
   * D-Bus

## Proposed Design

The main idea is to catch D-Bus requests sent by user interfaces, then handle the
request according to the configuration. In future, support for flexible policies
may be implemented that would allow for better flexibility in handling and
tracking.

The key benefit of using phosphor-audit is that all action handling will be kept
inside this project instead of spreading it across multiple dedicated interface
services with a risk of missing a handler for some action in one of them and
bloating the codebase.

The component diagram below shows the service overview.

```ascii
  +----------------+  audit event                           +-----------------+
  |    IPMI NET    +-----------+                            | action          |
  +----------------+           |                            | +-------------+ |
                               |                            | |    ph-log   | |
  +----------------+           |                            | +-------------+ |
  |   IPMI HOST    +-----------+      +--------------+      |                 |
  +----------------+           |      |    audit     |      | +-------------+ |
                               +----->+   service    +----->| |   command   | |
  +----------------+           |      |              |      | +-------------+ |
  |  RedFish/REST  +-----------+      +--------------+      |                 |
  +----------------+           |                            | +-------------+ |
                               |                            | |   notify    | |
  +----------------+           |                            | +-------------+ |
  | any UI service +-----------+                            |                 |
  +----------------+                                        | +-------------+ |
                                                            | |     ...     | |
                                                            | +-------------+ |
                                                            +-----------------+
```

The audit event from diagram generated by an application to track user activity.
The application sends 'method_call'/'signal' to audit service via D-Bus.
What's happened next in handler at audit service depends on user requirements
and needs. It is possible just to store logs or run arbitrary command or notify
someone in handler or we can do both and all of this can be optional.

As example of possible flow:

```ascii
           +----------------+
           |   NET   IPMI   |
           |    REQUEST     |
           +----------------+
                   |
 +--------------------------------------------------------------------------+
 |                 |                                                        |
 |         +-------v--------+                                         IPMI  |
 |         |                |                                               |
 |         |    NET IPMI    |                                               |
 |         |                |                                               |
 |         +----------------+                                               |
 |                 |                                                        |
 |         +-------v--------+    +--------------------------------------+   |
 |         |                |    |                                      |   |
 |         | rc=handle(cmd, +--->|    audit_event<NET_IPMI>             |   |
 |         |          input)|    |       (rc, req, user, host, data)    |   |
 |         |                |    |                                      |   |
 |         +----------------+    +--------------------------------------+   |
 |                 |                                |                       |
 |         +-------v--------+                       |                       |
 |         |   Processing   |                       |                       |
 |         |    further     |                       |                       |
 |         +----------------+                       |                       |
 |                                                  |                       |
 |                                                  |                       |
 |                                                  |                       |
 +--------------------------------------------------------------------------+
                                                    |
                                                    |
 +--------------------------------------------------------------------------+
 |                    +-----------------------------+                       |
 |                    |                                     Audit Service   |
 |                    |                                                     |
 |                    |                                                     |
 |                    |                                                     |
 |            +-------v--------+                                            |
 |        NO  |                |        YES                                 |
 |     +------+   Is logging   +------------------+                         |
 |     |      |    enabled     |                  |                         |
 |     |      |   for  type?   |                  |                         |
 |     |      +----------------+          +-------v---------+               |
 |     |                            NO    |                 |  YES          |
 |     |                       +----------+ Is request type +-----+         |
 |     |                       |          |    filtered?    |     |         |
 |     |                       |          |                 |     |         |
 |     |                       |          +-----------------+     |         |
 |     |                       |                                  |         |
 |     |               +-------v--------+                         |         |
 |     |               |     Notify     |                         |         |
 |     |               |  Administrator |                         |         |
 |     |               +----------------+                         |         |
 |     |                       |                                  |         |
 |     |               +-------v--------+                         |         |
 |     |               |   Log Event    |                         |         |
 |     |               +----------------+                         |         |
 |     |                       |                                  |         |
 |     |               +-------v--------+                         |         |
 |     |               |      User      |                         |         |
 |     |               |     actions    |                         |         |
 |     |               +----------------+                         |         |
 |     |                       |                                  |         |
 |     |               +-------v--------+                         |         |
 |     +-------------->|      End       |<------------------------+         |
 |                     +----------------+                                   |
 |                                                                          |
 +--------------------------------------------------------------------------+
```

**Audit event call**

Audit event call performs preprocessing of incoming data at application side
before sending it to the audit service, if the request is filtered out, it will
be dropped at this moment and will no longer be processed. After the filter
check, the audit event call sends the data through D-Bus to the audit service
which makes a decision regarding next steps.

 > `audit_event<type>(rc, request, user, host, data)`
 > *  type - type of event source : IPMI, REST, PAM, etc.
 > *  rc   - return code of the function that processed the event
 > *  request - a generalized identifier of the event, e.g. ipmi command
 > (cmd/netfn/lun), web path, or anything else that can describe the event.
 > *  user - the user account on behalf of which the event was processed
 > *  host - identifier of the host that the event has originated from. This can
 >     be literally "host" for events originating from the local host (via locally
 >     connected IPMI), or an IP address or a hostname of a remote host.
 > *  data - any supplementary data that can help better identify the event
 >      (e.g., some first bytes of the IPMI command data).

Service itself can control flow of events with configuration on its side.

## Service configuration

The configuration structure can be described as tree with set of options,
as example of structure:

```
[IPMI]
   [Enabled]
   [Filter]
     [Cmd 0x01] ["reset request"]
     [Cmd 0x02] ["hello world"]
     [Cmd 0x03] ["goodbye cruel world"]
   [Actions]
     [Notify type1] [Recipient]
     [Notify type2] [Recipient]
     [Notify type3] [Recipient]
     [Logging type] [Options]
     [Exec] [ExternalCommand]
[REST]
   [Disabled]
   [Blacklist]
     [Path1] [Options]
     [Path2] [Options]
   [Actions]
     [Notify type2] [Recipient]
     [Logging type] [Options]
```

Options can be updated via D-Bus properties or any other possible ways.

* The filtering and blacklisting

 > Possible list of requests which have to be filtered and processed.
 > 'Filter' filters possible requests which can be processed.
 > 'Blacklist' blocks only exact requests.

* Enable/disable the event processing for directed services

 > Each audit processing type can be disabled or enabled at runtime via
 > config file or D-Bus property.

* Notification setup via SNMP/E-mail/Instant messengers/D-Bus

 > The end recipient notification system with different transports.

* Logging

 > phosphor-logging, journald or anything else suitable for.

* User actions

 > Running a command as consequenced action.

## Notification mechanisms

The unified model for reporting accidents to the end user, where the transport can be:

* E-mail

  > Sending a note to directed recipient which set in configuration via
  > sendmail or anything else.

* SNMP

  > Sending a notification via SNMP trap messages to directed recipient which
  > set in configuration.

* Instant messengers

  > Sending a notification to directed recipient which set in configuration via
  > jabber/sametime/gtalk/etc.

* D-Bus

  > Notify the other service which set in configuration via 'method_call' or
  > 'signal'.

Notifications will be skipped in case if there is no any of above configuration
rules is set inside configuration. It is possible to pick up rules at runtime.

## User Actions

 * Exec application via 'system' call.
 * The code for directed handling type inside handler itself.

## Alternatives Considered

Processing user requests in each dedicated interface service and logging
them separately for each of the interfaces. Scattered handling looks like
an error-prone and rigid approach.

## Impacts

Improves system manageability and security.

## Testing
TBD
