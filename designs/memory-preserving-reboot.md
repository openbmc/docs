# Memory preserving reboot and System Dump extraction flow on OpenPOWER Systems.

  Author: Dhruvaraj S <dhruvaraj@in.ibm.com>

  Primary Assignee: Dhruvaraj S

  Created: 11/06/2019

## Problem Description

On OpenPOWER based servers, a hypervisor firmware manages and allocates
resources to the logical partitions running on the server. If this hypervisor
encounters an error and cannot continue with management operations, the server
needs to be restarted. A typical server reboot will erase the content of main
memory with the current running configuration of the logical partitions and the
data required for debugging the fault. The hypervisor on the OpenPOWER based
systems doesn't have access to a non-volatile storage to store this content
after a failure. A warm reboot with preserving the main memory is needed on the
OpenPOWER based servers to create a memory dump required for the debugging.
This document explains the high-level flow of warm reboot and extraction of the
resulting dump from the hypervisor memory.


## Glossary

- **Boot**: The process of initializing hardware components in a computer system
and loading the operating system.
- **Hostboot**: The firmware runs on the host processors and performs all
processor, bus, and memory initialization on OpenPOWER based servers.
[read more](https://github.com/open-power/docs/blob/master/hostboot/HostBoot_PG.md)
- **Self Boot Engine(SBE)**: A microcontroller built into the host processors
of OpenPOWER systems to assist in initializing the processor during the boot.
It also acts as an entry point for several hardware access operations to the
processor. [read more](https://sched.co/SPZP)
- **Master Processor**: The processor which gets initialized first to execute
boot firmware.
- **POWER Hardware Abstraction Layer(PHAL)**: A software component on the BMC
providing access to the OpenPOWER hardware
- **Hypervioser**: A hypervisor (or virtual machine monitor, VMM) is a computer
software, firmware, or hardware that creates and runs virtual machines.
[read more](https://en.wikipedia.org/wiki/Hypervisor)
- **System Dump**: A dump of main memory and hardware states for debugging the
faults in hypervisor.
- **Memory Preserving Reboot(MPIPL)**: A method of reboot with preserving the
contents of the volatile memory
- **Terminate Immediate(TI)**: A condition when the hypervisor encountered
a fatal error and cannot continue with the normal operations.
- **Attention**: The signal generated by the hardware or the firmware for
a specific event.
- **Redfish**: The Redfish standard is a suite of specifications that deliver
an industry-standard protocol providing a RESTful interface for the management
of servers, storage, networking, and converged infrastructure.
[Read More](https://en.wikipedia.org/wiki/Redfish_(specification))
- **OCC**: The On-Chip Controller (OCC) is a co-processor that is embedded
directly on the main processor die. The OCC can be used to control the processor
frequency, power consumption, and temperature to maximize performance and
minimize energy usage.
[Read More](https://openpowerfoundation.org/on-chip-controller-occ/)
- **Checkstop**: A severe error inside a processor core that causes a processor
core to stop all processing activities.
- **VPNOR**: PNOR is a host processor-based NOR flash where the hostboot
firmware is stored. VPNOR or Virtual PNOR is an area on the BMC flash which
acts as the PNOR.

## Background and References
When the OpenPOWER based server encounters a fault and needs a restart,
it alerts BMC to initiate a memory preserving reboot. BMC start the powering off
by informing the SBE on each of the processors. SBE stops the running cores and
collects the hardware states in a specified format. Once the data is collected,
the SBE returns control to the BMC. BMC then initiate a memory preserved boot.
Once the system finished booting, the hypervisor collects the hardware data and
memory contents to create a dump file in the host memory.

## Requirements

### Primary Requirements

-   System dump should be collected irrespective of the availability of an
    external entity to offload it at the time of a failure.
-   Should provide a mechanism to the user to request a system dump.
-   The server should boot back to runtime
-   Hypervisor should send special attention to
-   BMC should receive special TI attention from hypervisor
-   BMC should change the system state to 'maintenance.'
-   BMC inform SBE to start the MPIPL and collect the hardware data.
-   Error log associated with dump needs to be part of the dump package
-   A dump summary should be created with size and other details of the dump
-   Once the dump is generated, the hypervisor should notify BMC.
-   Hypervisor should offload the dump requested with dump id.
-   Provide Redfish interfaces to manage dump

## Proposed Design

### The flow
The flow of the memory preserving reboot and system dump offloading
![Memory preserving reboot and dump extraction flow](https://user-images.githubusercontent.com/16666879/70385938-81c3ef80-19b8-11ea-989f-1f158edda122.jpeg)
#### 1 - Server fault and notification to BMC
When there is a fault, the hypervisor generates attention. The attention
listener on the BMC detects the attention. In the case of OPAL systems,
an additional s0 interrupt will be sent to SBE to stop the cores immediately.
#### 2 -  Analyze the error data.
The attention listener on the BMC calls a chip-op to analyze the reason for the
attention.
#### 3 - Initiate System Dump
Attention on the BMC makes a dBus call to the dump manager with dump type as
a system dump to initiate a memory preserving reboot.
#### 4 - Initiate MPIPL transition
The Dump manager sets the systemd target for memory preserving reboot.
following steps are executed as part of this target
          - Set the system state to maintenance
          - Stop OCC
          - Disable watchdog
          - Disable checkstop monitoring
          - Issue enter_mpipl chip-op to each SBE
#### 5 - SBE collects the hardware data
Each SBE collects the architected states and store it into a pre-defined
location.
#### 6 - BMC Start warm boot
Once the SBE finishes the hardware collection, it does following to boot the
system with preserving the memory.
          - Reset VPNOR
          - Enable watchdog
          - Enable checkstop monitoring
          - Run istep proc_select_boot_master
          - Run istep sbe_config_update
          - Issue continue_mpipl chip-op instead of start_cbs on the
            master processor
#### 7 - Hostboot booting
Once SBE is started, it starts hostboot, hostboot copies the architected states
to the right location, move the memory contents to create the dump.
#### 8 - Hypervisor Formats dump and send notification to BMC
Once the hypervisor is started, it formats dump and send notification to BMC
through PLDM and with the dump size
PLDM calls the dump manager interface to notify the dump.
Dump manager creates a dBus object for the new dump, with status not offloaded
and dump size.
BMC web catches the object creation signal and notifies HMC.
#### 9 - HMC send request to dump offload
Once HMC is ready to offload, it creates NBD server and send dump offload
request to BMC.
BMC dump manager creates NBD client and NBD proxy to offload the dump.
BMC dump manager make a PLDM call with dump id provided by hypervisor and the
NBD device id. PLDM sends the offload request to the hypervisor with the dump
id.
#### 10 - Hypervisor starts dump offload
PHYP start sending down the dump packets through DMA
PLDM reads the DUMP and write to the NBD client endpoint
The data reaches the NBD server on the HMC and get written to a dump file.
#### 11 - Hypervisor sends down offload complete message
Hypervisor sends down offload complete message to BMC and BMC sends it to HMC.
The NBD endpoints are cleared.
#### 12 - HMC verifies dump and send dump DELETE to BMC.
HMC verifies the dump and send dump delete request to BMC
BMC sends the dump delete message to hypervisor
Hypervisor deletes dump in host memory.

### Memory preserve reboot sequence.
![Memory preserve reboot sequence](https://user-images.githubusercontent.com/16666879/70385954-d7000100-19b8-11ea-9900-e6d691277fb8.jpeg)

### Dump offload sequence
![Dump offload sequence](https://user-images.githubusercontent.com/16666879/70385965-30683000-19b9-11ea-91a8-a5fe9630beb0.jpeg)
## Alternatives Considered

## Impacts

## Testing

