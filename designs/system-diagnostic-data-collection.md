# System Diagnostic Data Collection on OpenBMC

Author: Chau Ly <chaul@amperecomputing.com> <chaulyvietnam>

Created: 2025-03-26

## Problem Description

Users should be able to request collecting diagnostic data from the system, and
keep track of the task status at any time.

This design focus on how user can request to collect host diagnostic data, and
how BMC handles these requests.

## Background and References

### System diagnostic data

Dump is the diagnostic data collected at any point of time from the system and
is stored in a file to troubleshoot the problems that may have occurred on the
system. The data may consist of application core, network configuration, system
inventory configuration, journal log, etc... The file can be stored in Host and
then offloaded through BMC.

### DMTF proposal

DMTF proposed an enhancement of `LogService` resource for Diagnostic Data before
(https://www.dmtf.org/sites/default/files/Redfish_Diagnostic_Data_Logging_Proposal_05-2020-WIP.pdf).
The enhancement has been partly implemented in OpenBMC's `bmcweb` repository,
which promotes the `CollectDiagnosticData` action in `LogService` schema under
`ComputerSystem` resource.

### OpenBMC Dump Manager

[Dump Manager design doc](https://github.com/openbmc/docs/blob/master/designs/dump-manager.md)
in OpenBMC defines a few types of dump in
[phosphor-dump-manager](https://github.com/openbmc/phosphor-debug-collector)
service, including: BMC Dump, System Dump, Resource Dump, Hostboot Dump,
Hardware Dump. Among these, System Dump and Resource Dump refer to debug
information and host dump that can be initiated to be collected by users and
offloaded through BMC.

The implementation for System Dump and Resource Dump are placed in IBM's
[openpower-dump](https://github.com/openbmc/phosphor-debug-collector/tree/master/dump-extensions/openpower-dumps)
subfolder of phosphor-debug-collector. Both involve a lot of OEM moves, and use
PLDM File Transfer to collect the dump from Host, create dump entries on D-Bus.

### PLDM File Transfer

[DSP0242 v1.0.0](https://www.dmtf.org/sites/default/files/standards/documents/DSP0242_1.0.0.pdf)
defines messages and data structures used for transferring files between PLDM
termini, within a PLDM subsystem. File Transfer specification describes the
mechanism that allows:

- Discovery of files, directories and file/directory metadata available on a
  PLDM terminus via PLDM PDR entries and File Transfer specific sensors, for
  transfer purpose between File Host and File Client
- Reading regular and serial FIFO type files

## Requirements

1. There should be a way through which user can collect the diagnostic data from
   the system and offload it through Redfish. These diagnostic data are stored
   in Host memory and can be collected by users at any moment of time.
2. Users should be able to monitor the status of the dump collecting task
   through Redfish.
3. Users should be able to introspect and download a dump entry through Redfish
   when the task status is complete.
4. Users should be able to delete a dump entry from BMC through Redfish.
5. BMC should be able to offload diagnostic data files from Host.
6. The offloading task should not be blocking the Redfish service.
7. Host should be able to notify a new system dump to BMC but it will not have
   data until users request to collect.
8. The dumps represented to users should not be duplicate in content.

## Proposed Design

### Redfish interfaces

The `.CollectDiagnosticData` action of
[LogService 1.4.0](https://www.dmtf.org/sites/default/files/standards/documents/DSP2046_2023.1.pdf)
schema of Redfish is enlisted to collect the system diagnostic data as
following:

`POST /redfish/v1/Systems/{ComputerSystemId}/LogServices/Dump/CollectDiagnosticData {   "DiagnosticDataType": "OEM",   "OEMDiagnosticDataType": "System" }`

The implementation for this action is already supported in `bmcweb`. The
`TaskService` and `LogEntry` schema implementation that allows requesting the
status of the log collecting task and the log entry information follows the
existing approaches of BMC Dump and FaultLog Dump collection in `bmcweb`.

The `.ClearLog` action of `LogServices` is used to delete a dump from the entry
collection. The `AttachmentURL` property of `LogEntry` schema is used to
download the entry.

These can meet requirements number 1, 2, 3 and 4.

### Dump interfaces

`phosphor-dbus-interfaces` already has the schema for Dump Entry interfaces, The
schema for
[System Dump Entry](https://github.com/openbmc/phosphor-dbus-interfaces/blob/master/yaml/xyz/openbmc_project/Dump/Entry/System.interface.yaml)
serves to represent host dump stored in host memory, generated by system or
requested by users, that can be offloaded through BMC.

For Dump Entry in general, there is an
[Entry interface](https://github.com/openbmc/phosphor-dbus-interfaces/blob/master/yaml/xyz/openbmc_project/Dump/Entry.interface.yaml)
that serves necessary aspects and functionalities of a dump.
[Dump Manager design doc](https://github.com/openbmc/docs/blob/master/designs/dump-manager.md)
has approached all the aspects of interfaces related to dump, such as
[Dump.Create](https://github.com/openbmc/phosphor-dbus-interfaces/blob/master/yaml/xyz/openbmc_project/Dump/Create.interface.yaml)
and
[Dump.NewDump](https://github.com/openbmc/phosphor-dbus-interfaces/blob/master/yaml/xyz/openbmc_project/Dump/NewDump.interface.yaml)
interfaces, with `CreateDump` and `Notify` methods which are respectively used
to request collecting of a dump type (user-created dump) and notify the creation
of a new dump ready to be offloaded.

A `system-dump-manager` service in `phopsphor-debug-collector` repo will handle
calls to `CreateDump` and `Notify` methods for system dump path
`xyz/openbmc_project/dump/system/` and work with `system-dump-collector` to
collect dumps.

A `system-dump-collector` service in the same repo will trigger collecting
system dumps from Host. Then it will work with `system-dump-manager` to notify
new dumps, initiate offloading these dumps and update dump entry content and
status. How this service trigger collecting and request offloading dumps from
Host is per OEM implementation, but these two tasks must be non-blocking.

Host can notify a new system dump to BMC by issuing requests to a BMC
application to call `Notify` method. How Host conducts this notification is per
OEM implementation.

The `Notify` method handled by `system-dump-manager` will delete the old dump
entry which shares the same
[SourceDumpId](https://github.com/openbmc/phosphor-dbus-interfaces/blob/10ad7d8df4dc29778e4ff144c819e1c0210671a3/yaml/xyz/openbmc_project/Dump/Entry/System.interface.yaml#L11)
property value with the newly-notified dump.

These can meet requirements number 5, 6, 7 and 8.

### BMC-Host interface

The interface for BMC to collect dumps and offload dumps from Host is per OEM
implementation and out of this design's scope.

### Component interactions

1. Users request BMC to collect system diagnostic data, introspect task status
   and dump entry, download or delete dump entry via Redfish out-of-band
   interface.
2. `bmcweb` handles Redfish requests and calls to the system dump interface
   hosted by `system-dump-manager` service in `phophor-debug-collector` repo.
3. `system-dump-manager` handles download, delete and introspection requests on
   its own. However, for dump creation request, it interacts with
   `system-dump-collector` to collect and offload dumps from Host.
4. How `system-dump-collector` triggers collecting dumps from Host is OEM
   implementation.

```
@startuml
component BMC {
    component bmcweb
    component sdm as "system-dump-manager"
    component sdc as "system-dump-collector"
}
component Host
component User
interface dump_inf as "System Dump Interface"

User <-> bmcweb: Redfish
bmcweb ..> () dump_inf: uses
sdm - dump_inf
sdm <-> sdc
sdc <-> Host
@enduml
```

### Diagnostic Data Retrieval sequence

Some error scenario during Redfish communication and the presence of `D-Bus`
between `bmcweb` and `system-dump-manager` will be implied and omitted from the
diagram for simplicity.

1.  Users request to collect Diagnostic Data of the system via Redfish with
    `POST /redfish/v1/Systems/{ComputerSystemId}/LogServices/{LogServiceId}/CollectDiagnosticData{"DiagnosticDataType": "OEM", "OEMDiagnosticDataType": "System"}`

    1. `bmcweb` calls
       [CreateDump](https://github.com/openbmc/phosphor-dbus-interfaces/blob/13289c9414b6838eaa8544cbfc393b5f2ef9672b/yaml/xyz/openbmc_project/Dump/Create.interface.yaml#L12)
       on the system dump path that is handled by `system-dump-manager`.
       `CreateDump` creates a system dump entry on D-Bus with basic information
       including an in-progress status, but has invalid `SourceDumpId` and zero
       `Size`. This will result in a task in Redfish that can be requested by
       user to read status of the dump entry. Then it calls to trigger
       collecting dumps which is handled by `system-dump-collector` and returns
       immediately. This asynchronous call is OEM implementation.

2.  When the dump-collecting task completes, `system-dump-collector` calls to
    `system-dump-manager` to notify about each dump and initiate offloading it.

    1. [Notify](https://github.com/openbmc/phosphor-dbus-interfaces/blob/13289c9414b6838eaa8544cbfc393b5f2ef9672b/yaml/xyz/openbmc_project/Dump/NewDump.interface.yaml#L12)
       method results in update to the created dump entry and maybe the creation
       of a new dump entry on D-Bus with size and source dump ID. Any existing
       dump entry with the same source dump ID with the new dump will be
       replaced.

    2. [InitiateOffload](https://github.com/openbmc/phosphor-dbus-interfaces/blob/13289c9414b6838eaa8544cbfc393b5f2ef9672b/yaml/xyz/openbmc_project/Dump/Entry.interface.yaml#L11)
       method to the dump entry results in an asynchronous call that is OEM
       implementation.

3.  When the request to offload each dump completes, `system-dump-collector`
    will call to `system-dump-manager` to update new status to the dump entry
    (completed/failed/aborted) and save the returned fd of the dump to memory
    (to a file in the hardcoded directory in /tmp/).

4.  Users request to introspect the dump entry via Redfish with
    `GET /redfish/v1/Systems/{ComputerSystemId}/LogServices/{LogServiceId}/Entries/{LogEntryId}`.

    1. `bmcweb` will get the entry properties from `system-dump-manager` and
       respond with the dump's information if the operational status is
       completed.

5.  Users request to download the dump entry via Redfish with
    `LogEntry/AttachementURL` schema
    `GET /redfish/v1/Systems/{ComputerSystemId}/LogServices/{LogServiceId}/Entries/{LogEntryId}/attachment`

    1. \_ 2. `bmcweb` calls to `system-dump-manager` to get the fd of the
       offloaded dump entry and write to user's ouput file.

```
@startuml
actor User
participant bmcweb as "bmcweb"
participant sdm as "system-dump-manager"
participant sdc as "system-dump-collector"

==Users request to collect dump==
User -> bmcweb ++: 1.Request to collect system diagnostic data

bmcweb -> sdm ++: 1.1.Request system dump creation <<CreateDump>>
sdm ->> sdc: 1.1.2.<<Async>> Trigger collecting dumps

sdm --> bmcweb --: return Dump Entry D-Bus path
bmcweb --> User --: 200 SUCCESS

==Handler of request to collect dumps==
note over sdc: 2.Handler of request to collect dumps
loop Dump files
    sdc -> sdm: 2.1.<<Notify>> creation of a new dump
    sdc -> sdm: 2.2.<<InitiateOffload>> the entry
    sdm ->> sdc: 2.3.<<Async>> Request offloading
end

==Handler of request to offload a dump==
note over sdc: 3.Handler of request to offload a dump
sdc -> sdm: 3.1.Update entry status and save returned fd to memory

==Users request to introspect dump entry==
User -> bmcweb ++: 4.Request to introspect dump entry
bmcweb -> sdm: 4.1.Get Entry properties
bmcweb -> bmcweb ++: 4.2.Parse properties
opt Status != Completed
    bmcweb --> bmcweb !!
    bmcweb --> User !!: Resource Not Found
end
bmcweb --> User --: 200 SUCCESS

==Users request to download dump entry==
User -> bmcweb ++: 5.Request to download dump entry
bmcweb -> sdm: 5.1.<<GetFileHandle>>
bmcweb -> bmcweb: 5.2.Write fd content to user's output file
bmcweb --> User --: 200 SUCCESS

@enduml
```

## Alternatives Considered

Make the communication between `system-dump-collector` and Host generic using
PLDM. However, after consideration, there can be a lot of differences in
perceptions and perspectives about system diagnostic data retrieval between each
platform when it comes to implementations. We should not expect all to share the
same practice because it may not suit their platform requirements. The
alternative design is as follow.

### Alternative BMC-Host interface

For `system-dump-collector` to collect dumps from Host to BMC, there needs to be
an interface to send request to Host and transfer dump data back to BMC.
Platform Level Data Model (PLDM) can be used to fulfill that with the presence
of PLDM File Transfer model that is to be implemented in `pldmd` repo as
described in [PLDM File Transfer](#pldm-file-transfer). In diagnostic data
collection flow, BMC is File Client, and any Satellite Management Controller
that is in charge of storing the system diagnostic data is File Host.

With this approach, BMC can have prior knowledge of the diagnostic data files
possible to be collected from Host in form of File Descriptor PDRs (DSP0248
v1.3.0 Table 108), and use File Transfer commands described in DSP0242 v1.0.0 to
offload the dump data (DfOpen/DfRead/DfClose). OEM can use the
`FileClassification` or `OemFileClassificationName` field in File Descriptor PDR
to distinguish the diagnostic data files from other files.

`pldmd` can publish these files as FUSE mountpoints or D-Bus file objects
depending on implementation, so `system-dump-collector` can interact with the
dump files. The file interface shall provide name, size and allow other
applications to read the file content. The dump file content shall be stored in
Host memory and only offloaded through BMC by issuing PLDM commands to Host upon
read. Users of the file interface will decide how the content will be stored
afterwards.

### Alternative component interactions

The first three interactions are the same to what were described in
[Component interactions](#component-interactions)

4. `system-dump-collector` looks for file object interfaces that are exposed by
   `pldmd`, and calls to the interfaces to retrieve dump entry's information and
   dump content to create/update to dump entries on D-Bus.

5. `pldmd` handles calls from `system-dump-manager` by issuing PLDM requests to
   Host and returning necessary information. If error happens during PLDM
   commnunication, `pldmd` will return approriate errors to
   `system-dump-manager`, which will result in corresponding response to user
   requests.

```
@startuml
component BMC {
    component bmcweb
    component sdm as "system-dump-manager"
    component sdc as "system-dump-collector"
    component pldmd
}
component Host
component User
interface dump_inf as "System Dump Interface"
interface file_inf as "File Interface"

User <-> bmcweb: Redfish
bmcweb ..> () dump_inf: uses
dump_inf - sdm
sdm - sdc
sdc ..> () file_inf: uses
file_inf - pldmd
pldmd <-> Host: PLDM
@enduml
```

### Alternative impacts

This alternative design will need to do more compared to the main design's
[impacts](#impacts):

- Add a new file object D-Bus interface to `phosphor-dbus-interfaces` or enlist
  [libfuse](https://github.com/libfuse/libfuse) to create FUSE mountpoints for
  File Descriptor PDRs.

- Implement PLDM File Transfer to `libpldm` and `pldmd` repo.

## Impacts

This change will need to:

- Support downloading a dump entry under `ComputerSystem` in `bmcweb` repo.
- Add a `system-dump-manager` to the existing dump manager classes in the
  `phosphor-debug-colletor` repo.
- Add a `system-dump-collector` service to `phosphor-debug-colletor` repo whose
  implementations can be overriden by OEM in an extension folder in the repo.

### Organizational

The repositories under impact will be: `bmcweb`, `phosphor-debug-collector`.

## Testing

Steps to test this feature out:

1. Request to collect system diagnostic data via Redfish and see if a system
   dump entry with basic info is created on D-Bus.
2. Calls Notify for a number of new dumps on system dump path and see if the new
   dump entries are created or updated to D-Bus.
3. Request to monitor the task status of the dump collecting action via Redfish
   and expect it to be In-progress.
4. This can be tested further by simulating a response to the dump offloading
   request with valid fd, then see if the status is now completed, and the entry
   can be introspected and downloaded via Redfish.
