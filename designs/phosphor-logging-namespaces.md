
# Namespaces in Phosphor Logging

Author: Shanjit Jajmann (shanjitsingh@gmail.com, liuc), Kun Zhao (zkxz@
hotmail.com, zkxz)
Primary assignee: Shanjit Jajmann (liuc)
Other contributors: Kun Zhao (zkxz), Deepak Kodahilli (dkodihal)
Created: Dec 19, 2021


## Problem Description
The idea behind this proposal is to enable namespace based logging in
phosphor-logging and being able to change certain properties of logging per
namespace.

With this proposal implemented, phosphor-logging will have the ability to
consume a user defined file which contains namespace names and properties (per
namespace) like Error Capacity, Error Info Capacity and Persistent Location,
ability to toggle namespace on/off. The user defined file is going to be in a
YAML format.

## Background and References
Phosphor Logging currently doesn't support any namespace ability. The current 
set of global configurations are managed via a header file inside 
`config/config.h.meson`. All the errors logged are logged under a single 
persistent location and there's no way to implement distinct properties per 
namespace i.e. Error Capacity , Error Info Capacity etc.

## Requirements

Our main requirement is to enable the ability of collecting error logs in
user-defined namespace with the properties associated with these being
modifiable. Currently, the properties covered in this design doc are limited
to Name of the namespace, Error Capacity, Error Info Capacity, Persistent
Storage location, Enable/Disabling particular namespace.

The names of the namespaces can correspond to devices or applications or some
specific identifiers to help the developers segregate the error logs being
generated by phosphor logging.

## Proposed Design
The phosphor-log-manager binary can consume a user-defined yaml file in the
following structure,
The namespaces below are per devices, this can help segregate logs per device.

```
namespaces:
gpu0:
    enabled: 1
    error_capacity: 20
    info_error_capacity: 10
    persistent_location: /var/lib/phosphor-logging/errors/gpu0
gpu1:
    enabled: 1
    error_capacity: 25
    info_error_capacity: 15
    persistent_location: /var/lib/phosphor-logging/errors/gpu1
gpu2:
    enabled: 1
    error_capacity: 30
    info_error_capacity: 20
    persistent_location: /var/lib/phosphor-logging/errors/gpu2
...
...
```

New "root" paths thus can be created which can add the DBUS Object Manager.
Per-namespace policies can then be built by consuming the properties from the
yaml file.

The design will account for,

1.  Backward compatibility (if no yaml file present):
The behaviour being implemented will ensure that there’s backward
compatibility with the current design. In case the user defined yaml file
isn't present, the current behavior of phosphor logging will prevail.

2.  Don’t break other apps:
Given dependence of phosphor-logging to other apps, it’s important that calls
to GetManagedObjects on the root path return all the objects (in all
namespaces). We want to make sure this occurs so that we don’t cause errors in
other apps. E.g. Redfish when showing log entries to users will continue to
see the default set of entries.

3.  Configure New Delete Policy for root path:
With the introduction of namespaces, a new DeletePolicy property will also be
introduced on the root path.

**`busctl introspect xyz.openbmc_project.Logging /xyz/openbmc_project/logging`**

| NAME  | TYPE  | SIGNATURE     | RESULT/VALUE  | FLAGS     |
|---    |---    |---    |---    |---    |
| org.freedesktop.DBus.Introspectable   | interface -   | -     | -     |   |
| .Introspect   | method    | -     | s     | -     |
| org.freedesktop.DBus.ObjectManager    | interface -   | -     | -     |   |
| .GetManagedObjects    | method    | -     | a{oa{sa{sv}}} -   |   |
| .InterfacesAdded  | signal    | oa{sa{sv}}    | -     | -     |
| .InterfacesRemoved    | signal    | oas   | -     | -     |
| org.freedesktop.DBus.Peer     | interface -   | -     | -     |   |
| .GetMachineId     | method    | -     | s     | -     |
| .Ping     | method    | -     | -     | -     |
| org.freedesktop.DBus.Properties   | interface -   | -     | -     |   |
| .Get  | method    | ss    | v     | -     |
| .GetAll   | method    | s     | a{sv}     | -     |
| .Set  | method    | ssv   | -     | -     |
| .PropertiesChanged    | signal    | sa{sv}as  | -     | -     |
| xyz.openbmc_project.Collection.DeleteAll interface -  | -     | -     |   |   |
| .DeleteAll    | method    | -     | -     | -     |
| `.DeletePolicy`   | `Property`    | `s`   | `-`   | `-`   |
| xyz.openbmc_project.Logging.Create    | interface -   | -     | -     |   |
| .Create   | method    | ssa{ss}   | -     | -     |
| .CreateWithFFDCFiles  | method    | ssa{ss}a(syyh) -  | -     |   |

The DeletePolicy property will control the behaviour of running the DeleteAll
method on the root object. By default, DeleteAll will delete all the objects
for all namespaces beneath the root object (this behaviour is in line with
current call of DeleteAll, it deletes all managed objects beneath the root
path). The other option which the DeletePolicy will provide is to be able to
delete objects for the default namespace only. The property will be
configurable via #defines in config.h for phosphor-logging or can be
configured via the yaml file.

Delete All behaviour for default and custom namespaces with varying
DeletePolicy,

|   | DeletePolicy = Default    | DeletePolicy = Namespace Only     |
|---    |:---:  |:---:  |
| Default Namespace     | Deletes all log entry objects in default namespace and all other namespaces as well (Current behaviour of calling DeleteAll on the default namespace)     | Deletes all log entry objects in the default namespace only (log entry objects for other namespaces untouched)    |
| Custom Namespace  | Deletes all log entry objects in the specific namespace only (Deletes the persistent storage directory for this namespace)    | Deletes all log entry objects in the specific namespace only (Deletes the persistent storage directory for this namespace)    |

From the code perspective, during initialization the internal manager shall
have an additional data structure to keep track of the namespace and its
properties. These properties will then be consumed by the internal manager
itself.

## Alternatives Considered

Section TBD

## Impacts

Documentation: This feature would be documented in the Phosphor Logging 
project's readme.md file.

API Impact: None of the existing APIs will be impacted.

## Testing

Two types of tests,

1.  CI test cases to make sure current behaviour isn’t impacted. (Should be
backward compatible)

2.  CI test cases to be written with prebuilt user defined files and busctl
commands to verify correct behaviour.
