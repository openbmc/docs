
# Machine Per-Build Code Coverage 

The following document details the code coverage system implemented for OpenBMC machine builds. 

OpenBMC currently relies on a manual system for detailing code coverage of any repositories used for image building. With each machine, there is a repo combination unique to it. This means that currently, if one wants to view the status and changes of those repositories, they would have to manually clone it and run unit tests on the correct version. This system automates the process and allows the aggregation of code coverage for the selected build.

The process itself follows the following format:
1. Image building
2. Storing src_uri and src_rev during image creation. 
3. Running unit tests on specified src_rev for repositories used.
4. LCov data aggregation. 
5. File cleanup and moving to another.

Currently, code coverage is only available for OpenBMC git repositories due to the structure of unit test files. However, future implementations can include support for other files and types of version control. 
  
## Download CI Image

Start by creating a repository for CI and CI scripts to be stored.

```
mkdir ci_test_area
cd ci_test_area
git clone https://github.com/openbmc/openbmc-build-scripts.git
```
 
## Image Building - Source file and revision aggregation:

The code coverage script relies on information gathered during image creation, with instructions on that available [here](https://github.com/openbmc/docs/blob/master/cheatsheet.md). While building the image, the src_uri and src_rev for each repository used needs to be stored for running unit tests.

* **[print_src.bbclass]** - Aggregates all files within the build that 	rely on git repositories. Stores any src_url and src_rev used during image creation. Found in `${BUILDDIR}/openbmc/classes`
 
To run, config files have to be modified to inherit new files. 

```
vi ${BUILDDIR}/conf/local.conf

Add to file:
INHERIT += “print-srcurl-srcrev”
```

## Running LCOV Aggregation

**[code-coverage.sh]** - Opens up “dependencies” file created by print_scr.bbclass, going through all listed src_url and src_rev.

To run, make sure you have a `${BUILDDIR}` set to the location where image was built. 

```
cd /path/to/ci_test_area
source openbmc-build-scripts/code-coverage.sh  
```

Running unit tests will generate the following path 
```
ci_test_area/<reponame>/build/meson-logs/coveragereport
```

The files in this directory store any LCOV/GCOV reports done by the unit tests. The following files parse the resulting lcov data and stores it aside. Specifically, the following file will be used by the rest of the program:
* **[index.html]** - Webpage report of lcov data generated by testcases.

